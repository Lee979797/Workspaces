<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.reimburse.com.my.sys.dao.SysUserDao">
    <select id="findUserByUserName" resultType="sysUser">
        select *
        from sys_users
        where username = #{username}
    </select>
    <select id="findUserPermissions" resultType="string">
        select m.permission
        from sys_users u
            join sys_user_roles ur
            join sys_role_menus rm
            join sys_menus m on u.id = ur.user_id and ur.role_id = rm.role_id and rm.menu_id = m.id
        where u.username = #{username}
    </select>
    <update id="updateObject" parameterType="sysUser">
        UPDATE sys_users
        SET
        <if test="username!=null and username!=''">username = #{username},</if>
        <if test="password!=null and password!=''">password = #{password},</if>
        <if test="email!=null and email!=''">email = #{email},</if>
        <if test="mobile!=null and mobile!=''">mobile = #{mobile},</if>
        <if test="modifiedUser!=null and modifiedUser!=''">modifiedUser = #{modifiedUser},</if>
        modifiedTime = now()
        WHERE id = #{id}
    </update>
    <select id="findObjectById" resultType="sysUser">
        select *
        from sys_users
        where id = #{id}
    </select>
    <insert id="insertObject" parameterType="sysUser" useGeneratedKeys="true" keyProperty="id">
        insert into sys_users (username, password, salt, email, mobile, createdTime, modifiedTime, createdUser, modifiedUser)
        values (#{username}, #{password}, #{salt}, #{email}, #{mobile}, now(), now(), #{createdUser},
                #{modifiedUser})
    </insert>
    <update id="validById">
        update sys_users
        set valid = #{valid}
        where id = #{id}
    </update>
    <sql id="pageWhere">
        <where>
            <if test="username!=null and username !=''">
                username like concat("%",#{username},"%")
            </if>
        </where>
    </sql>
    <select id="findPageObjects" resultType="sysUser">
        select * from sys_users
        <include refid="pageWhere"/>
        order by createdTime desc
        limit #{startIndex},#{pageSize}
    </select>
    <select id="getRowCount" resultType="int">
        select count(*) from sys_users
        <include refid="pageWhere"/>
    </select>
    <sql id="DeanPageWhere">
        <where>
            ur.role_id != 1
            <if test="username!=null and username !=''">
                and username like concat("%",#{username},"%")
            </if>
        </where>
    </sql>
    <select id="findPageObjectsForDean" resultType="sysUser">
        SELECT u.*
        FROM
        sys_users u
        JOIN sys_user_roles ur ON u.id = ur.user_id
        <include refid="DeanPageWhere"/>
        order by createdTime desc
        limit #{startIndex},#{pageSize}
    </select>
    <select id="getRowCountForDean" resultType="int">
        SELECT count(*)
        FROM
        sys_users u
        JOIN sys_user_roles ur ON u.id = ur.user_id
        <include refid="DeanPageWhere"/>
    </select>
    <select id="findRoleByUsername" resultType="string">
        select r.name
        from sys_users u
            join sys_user_roles ur
            join sys_roles r on u.id = ur.user_id and ur.role_id = r.id
        where u.username = #{username}
    </select>
</mapper>
